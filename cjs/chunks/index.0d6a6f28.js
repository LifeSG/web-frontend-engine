"use strict";var e=require("react"),t=require("./index.7b652ea6.js");require("react/jsx-runtime"),require("events"),require("buffer"),require("styled-components"),require("react-dom"),require("react-dom/server"),require("@lifesg/react-design-system"),require("@lifesg/react-icons/cross"),require("@lifesg/react-icons/pin-fill");exports.default=a=>{const{accepts:s,compress:r,dimensions:i,editImage:u,onChange:n,maxSizeInKb:l,outputType:o,upload:E,value:m}=a,{images:c,setImages:R,setErrorCount:g}=e.useContext(t.ImageContext),d=t.usePrevious(c),[p,I]=e.useState(0),S=t.usePrevious(m),f=e.useRef();e.useEffect((()=>{f.current=Array(5).fill(0).map((()=>Math.random().toString(36).slice(2))).join("")}),[]),e.useEffect((()=>{c.forEach(((e,a)=>{const i=d?.[a];if(e.status!==i?.status||e.dataURL!==i.dataURL)switch(e.status){case t.EImageStatus.INJECTED:t.FileHelper.dataUrlToBlob(e.dataURL).then((s=>{R((r=>{const i=[...r];return i[a]={...e,file:new File([s],e.name),status:t.EImageStatus.NONE},i}))})).catch((()=>{R((e=>e.filter(((e,t)=>t!==a))))}));break;case t.EImageStatus.NONE:t.FileHelper.getMimeType(e.file).then((i=>{i&&s.map(t.FileHelper.fileExtensionToMimeType).includes(i)?(R((s=>{const r=[...s];return r[a]={...e,name:t.FileHelper.deduplicateFileName(c.map((({name:e})=>e)),a,e.name),type:i,status:"schema"!==e.addedFrom?e.status:t.EImageStatus.UPLOADED},r})),"schema"!==e.addedFrom&&(r?D(a,e):U(a,e))):R((s=>{const r=[...s];return r[a]={...e,status:t.EImageStatus.ERROR_FORMAT},r}))}));break;case t.EImageStatus.TO_RECOMPRESS:O(a,e);break;case t.EImageStatus.COMPRESSED:case t.EImageStatus.CONVERTED:case t.EImageStatus.RECOMPRESSED:u||R((e=>{const s=[...e];return s[a]={...s[a],status:t.EImageStatus.UPLOAD_READY},s}));break;case t.EImageStatus.UPLOAD_READY:w(a,e)}}))}),[c.map((({status:e})=>e)).join(","),c.map((({dataURL:e})=>e)).join(",")]),e.useEffect((()=>{let e=0;c.forEach((a=>{(a.type&&!s.map(t.FileHelper.fileExtensionToMimeType).includes(a.type)||[t.EImageStatus.ERROR_GENERIC,t.EImageStatus.ERROR_SIZE].includes(a.status))&&e++})),g((t=>Math.max(0,t+e-p))),I(e),n({target:{value:c.filter((({status:e})=>e===t.EImageStatus.UPLOADED)).map((({dataURL:e,drawingDataURL:t,name:a,uploadResponse:s})=>({fileName:a,dataURL:t||e,uploadResponse:s})))}})}),[c.map((e=>e.status)).join(",")]),e.useEffect((()=>{void 0!==S&&void 0===m&&c.length&&R([])}),[void 0===S,void 0===m,c.length]);const h=(e,t)=>{let a=i.width/e;return t*a>i.height&&(a=i.height/t),a},U=async(e,a)=>{try{const s=await t.ImageHelper.convertBlob(a.file,t.FileHelper.fileExtensionToMimeType(o)),r=t.FileHelper.getFilesizeFromBase64(s);R(l&&r>1024*l?a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.ERROR_SIZE},s}:a=>{const r=[...a];return r[e]={...a[e],dataURL:s,status:t.EImageStatus.CONVERTED},r})}catch(a){R((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.ERROR_GENERIC},s}))}},D=async(e,a)=>{try{const s=await t.FileHelper.fileToDataUrl(a.file),r=await t.ImageHelper.dataUrlToImage(s),i={w:r.naturalWidth,h:r.naturalHeight},u=h(i.w,i.h);let n=await t.ImageHelper.resampleImage(r,{scale:u});if(l&&(n=await t.ImageHelper.compressImage(n,{fileSize:l})),l&&n.size>1024*l)R((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.ERROR_SIZE},s}));else{const a=await t.FileHelper.fileToDataUrl(n);R((s=>{const r=[...s];return r[e]={...s[e],dataURL:a,status:t.EImageStatus.COMPRESSED},r}))}}catch(a){R((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.ERROR_GENERIC},s}))}},O=async(e,a)=>{if(a.drawingDataURL)try{const s=await t.ImageHelper.dataUrlToImage(a.drawingDataURL),r={w:s.naturalWidth,h:s.naturalHeight},i=h(r.w,r.h);let u=await t.ImageHelper.resampleImage(s,{scale:i});if(u=await t.ImageHelper.compressImage(u,{fileSize:l}),u.size>1024*l){const a=[...c];a[e]={...c[e],status:t.EImageStatus.ERROR_SIZE},R(a)}else{const a=await t.FileHelper.fileToDataUrl(u),s=[...c];s[e]={...c[e],drawingDataURL:a,status:t.EImageStatus.RECOMPRESSED},R(s)}}catch(a){R((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.ERROR_GENERIC},s}))}},w=async(e,a)=>{try{let s;if(R((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.UPLOADING},s})),E?.method&&E?.url){const r=new FormData;r.append("dataURL",a.drawingDataURL||a.dataURL||""),r.append("sessionId",f.current||""),r.append("slot",`${a.slot}`),s=await new t.AxiosApiClient("",void 0,void 0,!0)[E.method](E.url,r,{onUploadProgress:t=>{const{loaded:a,total:s}=t,r=Math.floor(100*a/s);R((t=>{const a=[...t];return a[e]={...t[e],uploadProgress:r},a}))}})}R((a=>{const r=[...a];return r[e]={...a[e],uploadResponse:s,status:t.EImageStatus.UPLOADED},r}))}catch(a){R((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.ERROR_GENERIC},s}))}};return null};
//# sourceMappingURL=index.0d6a6f28.js.map
