"use strict";var e=require("react"),t=require("./index.dbe39e23.js");require("react/jsx-runtime"),require("@lifesg/react-design-system/text"),require("@lifesg/react-design-system/modal"),require("@lifesg/react-design-system/markup"),require("react-dom/server"),require("@lifesg/react-design-system/media"),require("events"),require("buffer"),require("@lifesg/react-design-system/color"),require("styled-components"),require("@lifesg/react-design-system/button"),require("@lifesg/react-design-system/alert"),require("@lifesg/react-design-system/layout"),require("@lifesg/react-design-system/box-container"),require("@lifesg/react-design-system/divider"),require("@lifesg/react-design-system/text-list"),require("@lifesg/react-design-system/tab"),require("@lifesg/react-design-system/filter"),require("@lifesg/react-design-system/uneditable-section"),require("@lifesg/react-design-system/timeline"),require("@lifesg/react-icons"),require("@lifesg/react-design-system/form"),require("@lifesg/react-design-system/toggle"),require("@lifesg/react-design-system/checkbox"),require("@lifesg/react-design-system/input-textarea"),require("@lifesg/react-design-system/file-upload"),require("@lifesg/react-icons/cross"),require("@lifesg/react-design-system/icon-button"),require("@lifesg/react-icons/pin-fill"),require("@lifesg/react-design-system"),require("@lifesg/react-design-system/image-button"),require("@lifesg/react-design-system/radio-button");const i=["image/jpeg","image/gif","image/png"];exports.default=a=>{const{compressImages:s,fileTypeRule:r,id:l,maxFileSizeRule:n,upload:u,uploadRule:o,value:m}=a,{files:d,setFiles:f,setCurrentFileIds:g}=e.useContext(t.FileUploadContext),c=t.usePrevious(m),{setValue:p}=t.useFormContext(),F=e.useRef();e.useEffect((()=>{F.current=t.generateRandomId()}),[]),e.useEffect((()=>{d.forEach((async(e,i)=>{try{switch(e.status){case t.EFileStatus.INJECTED:await w(e,i);break;case t.EFileStatus.NONE:await R(e,i);break;case t.EFileStatus.UPLOAD_READY:await U(e,i);break;case t.EFileStatus.TO_DELETE:S(i)}}catch(e){y(i)}}));const e=d.filter((({status:e})=>e===t.EFileStatus.UPLOADED)),i=e.filter((({addedFrom:e})=>"schema"!==e)).length>0,a=d.filter((({status:e})=>e===t.EFileStatus.TO_DELETE)).length>0,s=i||a;g(e.map((({fileItem:e})=>e.id))),p(l,e.map((({dataURL:e,fileItem:t,fileUrl:i,uploadResponse:a})=>({..."base64"===u.type?{dataURL:e}:{},fileId:t.id,fileName:t.name,fileUrl:i,uploadResponse:a}))),{shouldDirty:s,shouldTouch:i})}),[d.map((({fileItem:e,status:t})=>`${e?.id}-${t}`)).join(",")]),e.useEffect((()=>{void 0!==c&&void 0===m&&d.length&&f([])}),[d,c,f,m]);const y=e=>{f((i=>{const a=[...i],s=i[e];return a[e]={...s,fileItem:{...s.fileItem,id:s.fileItem?.id||t.generateRandomId(),name:s.rawFile.name,errorMessage:o?.errorMessage||t.ERROR_MESSAGES.UPLOAD().GENERIC},status:t.EFileStatus.ERROR_GENERIC},a}))},E=async(e,a)=>{if(i.includes(a||e.fileItem?.type)){const i=await t.ImageHelper.dataUrlToImage(e.dataURL),a=await t.ImageHelper.resampleImage(i,{width:94,height:94,crop:!0});return await t.FileHelper.fileToDataUrl(a)}return""},I=async e=>{const{addedFrom:i,dataURL:a,rawFile:s}=e,l=await t.FileHelper.getType(s);if(!(!r.fileType?.length||r.fileType?.includes(l.ext)))return{errorMessage:r.errorMessage||t.ERROR_MESSAGES.UPLOAD().FILE_TYPE(r.fileType||[]),fileType:l,status:t.EFileStatus.ERROR_FORMAT};if(n.maxSizeInKb>0){const e=1024*n.maxSizeInKb;if("base64"===u.type&&t.FileHelper.getFilesizeFromBase64(a)>e||"multipart"===u.type&&s.size>e)return{errorMessage:n.errorMessage||t.ERROR_MESSAGES.UPLOAD().MAX_FILE_SIZE(n.maxSizeInKb),fileType:l,status:t.EFileStatus.ERROR_SIZE}}return"schema"===i?{fileType:l,status:t.EFileStatus.UPLOADED}:{fileType:l,status:t.EFileStatus.UPLOAD_READY}},w=async(e,i)=>{let a;if(f((e=>{const a=[...e];return a[i]={...e[i],status:t.EFileStatus.INJECTING},a})),e.dataURL){const i=await t.FileHelper.dataUrlToBlob(e.dataURL);a=new File([i],e.rawFile.name)}else if(e.fileUrl){const i=await new t.AxiosApiClient("",void 0,void 0,!1,{responseType:"blob"}).get(e.fileUrl),s=await t.FileHelper.getType(new File([i],e.rawFile.name));a=new File([i],e.rawFile.name,{type:s.mime}),e.dataURL=await t.FileHelper.fileToDataUrl(a)}const{errorMessage:s,fileType:r}=await I({...e,rawFile:a}),l=await E(e,r.mime);f((n=>{const u=[...n];return u[i]={...e,fileItem:{errorMessage:s,id:e.fileItem?.id||t.generateRandomId(),name:t.FileHelper.deduplicateFileName(d.map((({fileItem:e})=>e?.name)),i,a.name),progress:1,size:a.size,type:r.mime,thumbnailImageDataUrl:l},rawFile:a,status:t.EFileStatus.UPLOADED},u}))},R=async(e,i)=>{const a=await q(e),s=await t.FileHelper.fileToDataUrl(a.rawFile),{errorMessage:r,fileType:l,status:n}=await I({dataURL:s,...a});f((e=>{const u=[...e];return u[i]={...a,dataURL:s,fileItem:{errorMessage:r,id:t.generateRandomId(),name:t.FileHelper.deduplicateFileName(d.map((({fileItem:e})=>e?.name)),i,a.rawFile.name),size:a.rawFile.size,type:l.mime,progress:0},status:n},u}))},U=async(e,i)=>{f((e=>{const a=[...e];return a[i]={...e[i],status:t.EFileStatus.UPLOADING},a}));const a=new FormData;a.append("sessionId",F.current||""),a.append("fileId",e.fileItem.id),a.append("slot",e.slot.toString()),"base64"===u.type?a.append("dataURL",e.dataURL):"multipart"===u.type&&a.append("file",e.rawFile,e.fileItem?.name);const s=await new t.AxiosApiClient("",void 0,void 0,!0).post(u.url,a,{headers:{"Content-Type":"base64"===u.type?"application/json":"multipart/form-data"},onUploadProgress:e=>{const{loaded:t,total:a}=e;f((e=>{if(!e[i])return e;const s=[...e];return s[i]={...e[i],fileItem:{...e[i].fileItem,progress:t/a}},s}))}}),r=await E(e);f((e=>{if(!e[i])return e;const a=[...e];return a[i]={...e[i],fileItem:{...e[i].fileItem,progress:1,thumbnailImageDataUrl:r},fileUrl:s?.data?.fileUrl,status:t.EFileStatus.UPLOADED,uploadResponse:s},a}))},S=e=>{f((t=>t.filter(((t,i)=>i!==e))))},q=async e=>{if(n.maxSizeInKb>0&&s){const a=1024*n.maxSizeInKb;if(e.rawFile.size>a){const a=await t.FileHelper.getType(e.rawFile);if(i.includes(a.mime)){let i=await t.ImageHelper.compressImage(e.rawFile,{fileSize:n.maxSizeInKb});return i instanceof Blob&&(i=t.FileHelper.blobToFile(i,{name:e.rawFile.name,lastModified:e.rawFile.lastModified})),{...e,rawFile:i}}}}return e};return null};
//# sourceMappingURL=file-upload-manager.e39c3927.js.map
