"use strict";var e=require("react"),t=require("./index.1fc417aa.js");require("react/jsx-runtime"),require("@lifesg/react-design-system/text"),require("@lifesg/react-design-system/markup"),require("react-dom/server"),require("@lifesg/react-design-system/media"),require("@lifesg/react-design-system/color"),require("styled-components"),require("@lifesg/react-design-system/button"),require("@lifesg/react-design-system/modal"),require("@lifesg/react-design-system/alert"),require("@lifesg/react-design-system/layout"),require("@lifesg/react-design-system/box-container"),require("@lifesg/react-design-system/divider"),require("@lifesg/react-design-system/text-list"),require("@lifesg/react-design-system/popover-v2"),require("@lifesg/react-icons"),require("@lifesg/react-design-system/tab"),require("@lifesg/react-design-system/button-with-icon"),require("@lifesg/react-design-system/error-display"),require("@lifesg/react-design-system/filter"),require("@lifesg/react-design-system/uneditable-section"),require("@lifesg/react-design-system/timeline"),require("@lifesg/react-design-system/form"),require("@lifesg/react-design-system/toggle"),require("@lifesg/react-design-system/checkbox"),require("@lifesg/react-design-system/input-textarea"),require("@lifesg/react-design-system/file-upload"),require("@lifesg/react-icons/cross"),require("@lifesg/react-design-system/icon-button"),require("@lifesg/react-icons/pin-fill"),require("@lifesg/react-design-system"),require("@lifesg/react-design-system/image-button"),require("@lifesg/react-design-system/radio-button");const i=["image/jpeg","image/gif","image/png"];exports.default=s=>{const{compressImages:a,fileTypeRule:r,id:l,maxFileSizeRule:n,upload:o,uploadRule:u,value:m}=s,{files:d,setFiles:f,setCurrentFileIds:g}=e.useContext(t.FileUploadContext),c=t.usePrevious(m),{setValue:p}=t.useFormContext(),y=e.useRef();e.useEffect((()=>{y.current=t.generateRandomId()}),[]),e.useEffect((()=>{d.forEach((async(e,i)=>{try{switch(e.status){case t.EFileStatus.INJECTED:await w(e,i);break;case t.EFileStatus.NONE:await R(e,i);break;case t.EFileStatus.UPLOAD_READY:await U(e,i);break;case t.EFileStatus.TO_DELETE:q(i)}}catch(e){F(i)}}));const e=d.filter((({status:e})=>e===t.EFileStatus.UPLOADED)),i=e.filter((({addedFrom:e})=>"schema"!==e)).length>0,s=d.filter((({status:e})=>e===t.EFileStatus.TO_DELETE)).length>0,a=i||s;g(e.map((({fileItem:e})=>e.id))),p(l,e.map((({dataURL:e,fileItem:t,fileUrl:i,uploadResponse:s})=>({..."base64"===o.type?{dataURL:e}:{},fileId:t.id,fileName:t.name,fileUrl:i,uploadResponse:s}))),{shouldDirty:a,shouldTouch:i})}),[d.map((({fileItem:e,status:t})=>`${e?.id}-${t}`)).join(",")]),e.useEffect((()=>{void 0!==c&&void 0===m&&d.length&&f([])}),[d,c,f,m]);const F=e=>{f((i=>{const s=[...i],a=i[e];return s[e]={...a,fileItem:{...a.fileItem,id:a.fileItem?.id||t.generateRandomId(),name:a.rawFile.name,errorMessage:u?.errorMessage||t.ERROR_MESSAGES.UPLOAD().GENERIC},status:t.EFileStatus.ERROR_GENERIC},s}))},E=async(e,s)=>{if(i.includes(s||e.fileItem?.type)){const i=await t.ImageHelper.dataUrlToImage(e.dataURL),s=await t.ImageHelper.resampleImage(i,{width:94,height:94,crop:!0});return await t.FileHelper.fileToDataUrl(s)}return""},I=async e=>{const{addedFrom:i,dataURL:s,rawFile:a}=e,l=await t.FileHelper.getType(a);if(!(!r.fileType?.length||r.fileType?.includes(l.ext)))return{errorMessage:r.errorMessage||t.ERROR_MESSAGES.UPLOAD().FILE_TYPE(r.fileType||[]),fileType:l,status:t.EFileStatus.ERROR_FORMAT};if(n.maxSizeInKb>0){const e=1024*n.maxSizeInKb;if("base64"===o.type&&t.FileHelper.getFilesizeFromBase64(s)>e||"multipart"===o.type&&a.size>e)return{errorMessage:n.errorMessage||t.ERROR_MESSAGES.UPLOAD().MAX_FILE_SIZE(n.maxSizeInKb),fileType:l,status:t.EFileStatus.ERROR_SIZE}}return"schema"===i?{fileType:l,status:t.EFileStatus.UPLOADED}:{fileType:l,status:t.EFileStatus.UPLOAD_READY}},w=async(e,i)=>{let s;if(f((e=>{const s=[...e];return s[i]={...e[i],status:t.EFileStatus.INJECTING},s})),e.dataURL){const i=await t.FileHelper.dataUrlToBlob(e.dataURL);s=new File([i],e.rawFile.name)}else if(e.fileUrl){const i=await new t.AxiosApiClient("",void 0,void 0,!1,{responseType:"blob"}).get(e.fileUrl),a=await t.FileHelper.getType(new File([i],e.rawFile.name));s=new File([i],e.rawFile.name,{type:a.mime}),e.dataURL=await t.FileHelper.fileToDataUrl(s)}const{errorMessage:a,fileType:r}=await I({...e,rawFile:s}),l=await E(e,r.mime);f((n=>{const o=[...n];return o[i]={...e,fileItem:{errorMessage:a,id:e.fileItem?.id||t.generateRandomId(),name:t.FileHelper.deduplicateFileName(d.map((({fileItem:e})=>e?.name)),i,s.name),progress:1,size:s.size,type:r.mime,thumbnailImageDataUrl:l},rawFile:s,status:t.EFileStatus.UPLOADED},o}))},R=async(e,i)=>{const s=await S(e),a=await t.FileHelper.fileToDataUrl(s.rawFile),{errorMessage:r,fileType:l,status:n}=await I({dataURL:a,...s});f((e=>{const o=[...e];return o[i]={...s,dataURL:a,fileItem:{errorMessage:r,id:t.generateRandomId(),name:t.FileHelper.deduplicateFileName(d.map((({fileItem:e})=>e?.name)),i,s.rawFile.name),size:s.rawFile.size,type:l.mime,progress:0},status:n},o}))},U=async(e,i)=>{f((e=>{const s=[...e];return s[i]={...e[i],status:t.EFileStatus.UPLOADING},s}));const s=new FormData;s.append("sessionId",y.current||""),s.append("fileId",e.fileItem.id),s.append("slot",e.slot.toString()),"base64"===o.type?s.append("dataURL",e.dataURL):"multipart"===o.type&&s.append("file",e.rawFile,e.fileItem?.name);const a=await new t.AxiosApiClient("",void 0,void 0,!0).post(o.url,s,{headers:{"Content-Type":"base64"===o.type?"application/json":"multipart/form-data"},onUploadProgress:e=>{const{loaded:t,total:s}=e;f((e=>{if(!e[i])return e;const a=[...e];return a[i]={...e[i],fileItem:{...e[i].fileItem,progress:t/s}},a}))}}),r=await E(e);f((e=>{if(!e[i])return e;const s=[...e];return s[i]={...e[i],fileItem:{...e[i].fileItem,progress:1,thumbnailImageDataUrl:r},fileUrl:a?.data?.fileUrl,status:t.EFileStatus.UPLOADED,uploadResponse:a},s}))},q=e=>{f((t=>t.filter(((t,i)=>i!==e))))},S=async e=>{if(n.maxSizeInKb>0&&a){const s=1024*n.maxSizeInKb;if(e.rawFile.size>s){const s=await t.FileHelper.getType(e.rawFile);if(i.includes(s.mime)){let i=await t.ImageHelper.compressImage(e.rawFile,{fileSize:n.maxSizeInKb});return i instanceof Blob&&(i=t.FileHelper.blobToFile(i,{name:e.rawFile.name,lastModified:e.rawFile.lastModified})),{...e,rawFile:i}}}}return e};return null};
//# sourceMappingURL=file-upload-manager.a8c50a82.js.map
