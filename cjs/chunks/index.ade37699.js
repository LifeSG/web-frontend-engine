"use strict";var e=require("react"),t=require("./index.7db1a25b.js");require("react/jsx-runtime"),require("@lifesg/react-design-system/theme"),require("styled-components"),require("@lifesg/react-design-system/typography"),require("@lifesg/react-design-system/button"),require("@lifesg/react-design-system/modal"),require("@lifesg/react-design-system/markup"),require("react-dom/server"),require("@lifesg/react-design-system/alert"),require("@lifesg/react-design-system/layout"),require("@lifesg/react-design-system/box-container"),require("@lifesg/react-design-system/divider"),require("@lifesg/react-design-system/v2_media"),require("@lifesg/react-design-system/text-list"),require("@lifesg/react-design-system/popover-v2"),require("@lifesg/react-icons"),require("@lifesg/react-design-system/tab"),require("@lifesg/react-icons/plus-circle-fill"),require("@lifesg/react-design-system/button-with-icon"),require("@lifesg/react-design-system/error-display"),require("@lifesg/react-design-system/filter"),require("@lifesg/react-design-system/uneditable-section"),require("@lifesg/react-design-system/timeline"),require("@lifesg/react-design-system/form"),require("@lifesg/react-design-system/checkbox"),require("@lifesg/react-design-system/toggle"),require("@lifesg/react-design-system/file-upload"),require("@lifesg/react-icons/cross"),require("@lifesg/react-design-system/icon-button"),require("@lifesg/react-icons/bin"),require("@lifesg/react-icons/eraser"),require("@lifesg/react-icons/pencil"),require("@lifesg/react-icons/pencil-stroke"),require("@lifesg/react-icons/plus"),require("@lifesg/react-icons/exclamation-triangle"),require("@lifesg/react-icons/pin-fill"),require("@lifesg/react-design-system/image-button"),require("@lifesg/react-design-system/radio-button"),require("@lifesg/react-design-system/v2_layout");exports.default=a=>{const{accepts:s,compress:r,crop:i,dimensions:n,editImage:l,id:u,maxSizeInKb:c,outputType:o,upload:g,value:m}=a,{images:d,setImages:E,setErrorCount:p,setCurrentFileIds:f}=e.useContext(t.ImageContext),I=t.usePrevious(d),R=t.usePrevious(m),{setValue:h}=t.useFormContext(),y=e.useRef(),S=e.useRef(0),{dispatchFieldEvent:q,addFieldEventListener:D,removeFieldEventListener:w}=t.useFieldEvent();e.useEffect((()=>{const e=e=>{E((t=>{const a=t.findIndex((t=>t.id===e.detail.id)),s={...t[a]};s.status=e.detail.updatedStatus,s.customErrorMessage=e.detail.errorMessage;const r=[...t];return r.splice(a,1,s),r}))};return D("update-image-status",u,e),()=>w("update-image-status",u,e)}),[D,u,w,E]),e.useEffect((()=>{y.current=t.generateRandomId()}),[]),e.useEffect((()=>{d.forEach(((e,a)=>{const i=I?.[a];if(e.status!==i?.status||e.dataURL!==i.dataURL)switch(e.status){case t.EImageStatus.INJECTED:t.FileHelper.dataUrlToBlob(e.dataURL).then((s=>{E((r=>{const i=[...r];return i[a]={...e,file:new File([s],e.name),status:t.EImageStatus.NONE},i}))})).catch((()=>{E((e=>e.filter(((e,t)=>t!==a))))}));break;case t.EImageStatus.NONE:t.FileHelper.getType(e.file).then((i=>{const n=i.mime;n&&s.map(t.FileHelper.fileExtensionToMimeType).includes(n)?(E((s=>{const r=[...s];return r[a]={...e,name:t.FileHelper.deduplicateFileName(d.map((({name:e})=>e)),a,t.FileHelper.sanitizeFileName(e.name)),type:n,status:"schema"!==e.addedFrom?e.status:t.EImageStatus.UPLOADED},r})),"schema"!==e.addedFrom&&(r?T(a,e):U(a,e))):E((s=>{const r=[...s];return r[a]={...e,status:t.EImageStatus.ERROR_FORMAT},r}))}));break;case t.EImageStatus.TO_RECOMPRESS:F(a,e);break;case t.EImageStatus.COMPRESSED:case t.EImageStatus.CONVERTED:case t.EImageStatus.RECOMPRESSED:if(!l){const s=!q("upload-ready",u,{imageData:e});E((e=>{const r=[...e];return r[a]={...r[a],status:s?t.EImageStatus.PENDING:t.EImageStatus.UPLOAD_READY},r}))}break;case t.EImageStatus.UPLOAD_READY:L(a,e);break;case t.EImageStatus.TO_DELETE:E((e=>e.filter((({status:e})=>e!==t.EImageStatus.TO_DELETE))));break;case t.EImageStatus.UPLOADED:q("uploaded",u,{imageData:e})}}))}),[d.map((({status:e})=>e)).join(","),d.map((({dataURL:e})=>e)).join(",")]),e.useEffect((()=>{let e=0;d.forEach((a=>{(a.type&&!s.map(t.FileHelper.fileExtensionToMimeType).includes(a.type)||[t.EImageStatus.ERROR_GENERIC,t.EImageStatus.ERROR_SIZE].includes(a.status))&&e++})),p((t=>Math.max(0,t+e-S.current))),S.current=e;const a=d.filter((({status:e})=>e===t.EImageStatus.UPLOADED||e===t.EImageStatus.ERROR_CUSTOM_MUTED)),r=a.filter((({addedFrom:e})=>"schema"!==e)),i=d.filter((({status:e})=>e===t.EImageStatus.TO_DELETE)).length>0,n=r.length>0,l=n||i;f(a.map((({id:e})=>e))),h(u,a.map((({id:e,dataURL:t,drawingDataURL:a,name:s,metadata:r,uploadResponse:i})=>({fileId:e,fileName:s,dataURL:a||t,metadata:r,uploadResponse:i}))),{shouldDirty:l,shouldTouch:n})}),[s,u,d,p,h]),e.useEffect((()=>{void 0!==R&&void 0===m&&d.length&&E([])}),[void 0===R,void 0===m,d.length]);const O=(e,t)=>{let a=n.width/e;return t*a>n.height&&(a=n.height/t),a},U=async(e,a)=>{try{const s=await t.ImageHelper.convertBlob(a.file,t.FileHelper.fileExtensionToMimeType(o)),r=t.FileHelper.getFilesizeFromBase64(s);if(c&&r>1024*c)E((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.ERROR_SIZE},s}));else{const r=await t.ImageHelper.getMetadata(a.file);E((a=>{const i=[...a];return i[e]={...a[e],dataURL:s,metadata:r,status:t.EImageStatus.CONVERTED},i}))}}catch(a){E((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.ERROR_GENERIC},s}))}},T=async(e,a)=>{try{const s=await t.ImageHelper.convertBlob(a.file,t.FileHelper.fileExtensionToMimeType(o)),r=await t.ImageHelper.dataUrlToImage(s),l={w:r.naturalWidth,h:r.naturalHeight};let u;if(i)u=await t.ImageHelper.resampleImage(r,{width:n.width,height:n.height,crop:!0});else{const e=O(l.w,l.h);u=await t.ImageHelper.resampleImage(r,{scale:e})}if(c&&(u=await t.ImageHelper.compressImage(u,{fileSize:c})),c&&u.size>1024*c)E((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.ERROR_SIZE},s}));else{const s=await t.ImageHelper.getMetadata(a.file),r=await t.FileHelper.fileToDataUrl(u);E((a=>{const i=[...a];return i[e]={...a[e],dataURL:r,metadata:s,status:t.EImageStatus.COMPRESSED},i}))}}catch(a){E((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.ERROR_GENERIC},s}))}},F=async(e,a)=>{if(a.drawingDataURL)try{const s=await t.ImageHelper.dataUrlToImage(a.drawingDataURL),r={w:s.naturalWidth,h:s.naturalHeight};let l;if(i)l=await t.ImageHelper.resampleImage(s,{width:n.width,height:n.height,crop:!0});else{const e=O(r.w,r.h);l=await t.ImageHelper.resampleImage(s,{scale:e})}if(l=await t.ImageHelper.compressImage(l,{fileSize:c}),l.size>1024*c){const a=[...d];a[e]={...d[e],status:t.EImageStatus.ERROR_SIZE},E(a)}else{const a=await t.FileHelper.fileToDataUrl(l),s=[...d];s[e]={...d[e],drawingDataURL:a,status:t.EImageStatus.RECOMPRESSED},E(s)}}catch(a){E((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.ERROR_GENERIC},s}))}},L=async(e,a)=>{try{let s;if(E((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.UPLOADING},s})),g?.method&&g?.url){const r=new FormData;r.append("dataURL",a.drawingDataURL||a.dataURL||""),r.append("sessionId",g?.sessionId||y.current||""),r.append("slot",`${a.slot}`),s=await new t.AxiosApiClient("",void 0,void 0,!0)[g.method](g.url,r,{onUploadProgress:t=>{const{loaded:a,total:s}=t,r=Math.floor(100*a/s);E((t=>{const a=[...t];return a[e]={...t[e],uploadProgress:r},a}))}})}E((a=>{const r=[...a];return r[e]={...a[e],uploadResponse:s,status:t.EImageStatus.UPLOADED},r}))}catch(a){E((a=>{const s=[...a];return s[e]={...a[e],status:t.EImageStatus.ERROR_GENERIC},s}))}};return null};
//# sourceMappingURL=index.ade37699.js.map
