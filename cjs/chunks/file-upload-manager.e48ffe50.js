"use strict";var e=require("react"),i=require("./index.4bd4aaf3.js");require("react/jsx-runtime"),require("@lifesg/react-design-system/theme"),require("styled-components"),require("@lifesg/react-design-system/markup"),require("react-dom/server"),require("@lifesg/react-design-system/typography"),require("@lifesg/react-design-system/button"),require("@lifesg/react-design-system/modal"),require("@lifesg/react-design-system/alert"),require("@lifesg/react-design-system/layout"),require("@lifesg/react-design-system/box-container"),require("@lifesg/react-design-system/divider"),require("@lifesg/react-design-system/v2_media"),require("@lifesg/react-design-system/text-list"),require("@lifesg/react-design-system/popover-v2"),require("@lifesg/react-icons"),require("@lifesg/react-design-system/tab"),require("@lifesg/react-icons/plus-circle-fill"),require("@lifesg/react-design-system/button-with-icon"),require("@lifesg/react-design-system/error-display"),require("@lifesg/react-design-system/filter"),require("@lifesg/react-design-system/uneditable-section"),require("@lifesg/react-design-system/timeline"),require("@lifesg/react-design-system/form"),require("@lifesg/react-design-system/checkbox"),require("@lifesg/react-design-system/toggle"),require("@lifesg/react-design-system/file-upload"),require("@lifesg/react-icons/cross"),require("@lifesg/react-design-system/icon-button"),require("@lifesg/react-icons/bin"),require("@lifesg/react-icons/eraser"),require("@lifesg/react-icons/pencil"),require("@lifesg/react-icons/pencil-stroke"),require("@lifesg/react-icons/plus"),require("@lifesg/react-icons/exclamation-triangle"),require("@lifesg/react-icons/pin-fill"),require("@lifesg/react-design-system/image-button"),require("@lifesg/react-design-system/radio-button"),require("@lifesg/react-design-system/v2_layout");const t=["image/jpeg","image/gif","image/png"];exports.default=s=>{const{compressImages:a,fileTypeRule:r,hideThumbnail:l,id:n,maxFileSizeRule:o,upload:u,uploadRule:m,value:d}=s,{files:c,setFiles:f,setCurrentFileIds:g}=e.useContext(i.FileUploadContext),p=i.usePrevious(d),{setValue:y}=i.useFormContext(),{dispatchFieldEvent:F}=i.useFieldEvent(),E=e.useRef();e.useEffect((()=>{E.current=i.generateRandomId()}),[]),e.useEffect((()=>{c.forEach((async(e,t)=>{try{switch(e.status){case i.EFileStatus.INJECTED:await U(e,t);break;case i.EFileStatus.NONE:await b(e,t);break;case i.EFileStatus.UPLOAD_READY:await T(e,t);break;case i.EFileStatus.TO_DELETE:h(t)}}catch(e){I(t)}}));const e=c.filter((({status:e})=>e===i.EFileStatus.UPLOADED)),t=e.filter((({addedFrom:e})=>"schema"!==e)).length>0,s=c.filter((({status:e})=>e===i.EFileStatus.TO_DELETE)).length>0,a=t||s;g(e.map((({fileItem:e})=>e.id))),y(n,e.map((({dataURL:e,fileItem:i,fileUrl:t,uploadResponse:s})=>({..."base64"===u.type?{dataURL:e}:{},fileId:i.id,fileName:i.name,fileUrl:t,uploadResponse:s}))),{shouldDirty:a,shouldTouch:t})}),[c.map((({fileItem:e,status:i})=>`${e?.id}-${i}`)).join(",")]),e.useEffect((()=>{void 0!==p&&void 0===d&&c.length&&f([])}),[c,p,f,d]);const I=e=>{f((t=>{const s=[...t],a=t[e];return s[e]={...a,fileItem:{...a.fileItem,id:a.fileItem?.id||i.generateRandomId(),name:a.rawFile.name,errorMessage:m?.errorMessage||i.ERROR_MESSAGES.UPLOAD().GENERIC},status:i.EFileStatus.ERROR_GENERIC},s}))},R=async(e,s)=>{if(!0!==l&&t.includes(s||e.fileItem?.type)){const t=await i.ImageHelper.dataUrlToImage(e.dataURL),s=await i.ImageHelper.resampleImage(t,{width:94,height:94,crop:!0});return await i.FileHelper.fileToDataUrl(s)}return""},w=async e=>{const{addedFrom:t,dataURL:s,rawFile:a}=e,r=await i.FileHelper.getType(a),l=q(r);if(l?.status<0)return l;const n="base64"===u.type?i.FileHelper.getFilesizeFromBase64(s):a.size,{errorMessage:o,status:m}=S(n);return m<0?{errorMessage:o,fileType:r,status:m}:"schema"===t?{fileType:r,status:i.EFileStatus.UPLOADED}:{fileType:r,status:i.EFileStatus.UPLOAD_READY}},q=e=>!r.fileType?.length||r.fileType?.includes(e.ext)?{}:{errorMessage:r.errorMessage||i.ERROR_MESSAGES.UPLOAD().FILE_TYPE(r.fileType||[]),fileType:e,status:i.EFileStatus.ERROR_FORMAT},S=e=>{if(o.maxSizeInKb>0){if(e>1024*o.maxSizeInKb)return{errorMessage:o.errorMessage||i.ERROR_MESSAGES.UPLOAD().MAX_FILE_SIZE(o.maxSizeInKb),status:i.EFileStatus.ERROR_SIZE}}return{}},U=async(e,t)=>{let s;if(f((e=>{const s=[...e];return s[t]={...e[t],status:i.EFileStatus.INJECTING},s})),e.dataURL){const t=await i.FileHelper.dataUrlToBlob(e.dataURL);s=new File([t],e.rawFile.name)}else if(e.fileUrl){const t=await new i.AxiosApiClient("",void 0,void 0,!1,{responseType:"blob"}).get(e.fileUrl),a=await i.FileHelper.getType(new File([t],e.rawFile.name));s=new File([t],e.rawFile.name,{type:a.mime}),e.dataURL=await i.FileHelper.fileToDataUrl(s)}const{errorMessage:a,fileType:r}=s?await w({...e,rawFile:s}):q({mime:e.uploadResponse?.mimeType,ext:e.uploadResponse?.ext}),{errorMessage:l}=S(s?.size||e.uploadResponse?.fileSize),n=s?await R(e,r?.mime):void 0;f((o=>{const u=[...o];return u[t]={...e,fileItem:{errorMessage:a||l,id:e.fileItem?.id||i.generateRandomId(),name:i.FileHelper.deduplicateFileName(c.map((({fileItem:e})=>e.name)),t,s?.name||e.rawFile.name),progress:1,size:s?.size||e.uploadResponse?.fileSize,type:r?.mime||e.uploadResponse?.mimeType,thumbnailImageDataUrl:n},rawFile:s,status:i.EFileStatus.UPLOADED},u}))},b=async(e,t)=>{const s=await D(e),a=await i.FileHelper.fileToDataUrl(s.rawFile),{errorMessage:r,fileType:l,status:n}=await w({dataURL:a,...s});f((e=>{const o=[...e];return o[t]={...s,dataURL:a,fileItem:{errorMessage:r,id:i.generateRandomId(),name:i.FileHelper.deduplicateFileName(c.map((({fileItem:e})=>e?.name)),t,i.FileHelper.sanitizeFileName(s.rawFile.name)),size:s.rawFile.size,type:l.mime,progress:0},status:n},o}))},T=async(e,t)=>{f((e=>{const s=[...e];return s[t]={...e[t],status:i.EFileStatus.UPLOADING},s}));const s=new FormData;s.append("sessionId",u?.sessionId||E.current||""),s.append("fileId",e.fileItem.id),s.append("slot",e.slot.toString()),"base64"===u.type?s.append("dataURL",e.dataURL):"multipart"===u.type&&s.append("file",e.rawFile,e.fileItem?.name);try{const a=await new i.AxiosApiClient("",void 0,void 0,!0).post(u.url,s,{headers:{"Content-Type":"base64"===u.type?"application/json":"multipart/form-data",...u.headers},onUploadProgress:e=>{const{loaded:i,total:s}=e;f((e=>{if(!e[t])return e;const a=[...e];return a[t]={...e[t],fileItem:{...e[t].fileItem,progress:i/s}},a}))}}),r=await R(e);f((e=>{if(!e[t])return e;const s=[...e];return s[t]={...e[t],fileItem:{...e[t].fileItem,progress:1,thumbnailImageDataUrl:r},fileUrl:a?.data?.fileUrl,status:i.EFileStatus.UPLOADED,uploadResponse:a},s}))}catch(i){throw F("upload-error",n,{fileId:e.fileItem.id,errorData:i?.response?.data}),i}},h=e=>{f((i=>i.filter(((i,t)=>t!==e))))},D=async e=>{if(o.maxSizeInKb>0&&a){const s=1024*o.maxSizeInKb;if(e.rawFile.size>s){const s=await i.FileHelper.getType(e.rawFile);if(t.includes(s.mime)){let t=await i.ImageHelper.compressImage(e.rawFile,{fileSize:o.maxSizeInKb});return t instanceof Blob&&(t=i.FileHelper.blobToFile(t,{name:e.rawFile.name,lastModified:e.rawFile.lastModified})),{...e,rawFile:t}}}}return e};return null};
//# sourceMappingURL=file-upload-manager.e48ffe50.js.map
