"use strict";var e=require("react"),t=require("./index.c33718c6.js");require("react/jsx-runtime"),require("@lifesg/react-design-system/media"),require("@lifesg/react-design-system/text"),require("@lifesg/react-design-system/color"),require("styled-components"),require("@lifesg/react-design-system/button"),require("@lifesg/react-design-system/modal"),require("@lifesg/react-design-system/markup"),require("react-dom/server"),require("@lifesg/react-design-system/alert"),require("@lifesg/react-design-system/layout"),require("@lifesg/react-design-system/box-container"),require("@lifesg/react-design-system/divider"),require("@lifesg/react-design-system/text-list"),require("@lifesg/react-design-system/popover-v2"),require("@lifesg/react-icons"),require("@lifesg/react-design-system/tab"),require("@lifesg/react-design-system/button-with-icon"),require("@lifesg/react-design-system/error-display"),require("@lifesg/react-design-system/filter"),require("@lifesg/react-design-system/uneditable-section"),require("@lifesg/react-design-system/timeline"),require("@lifesg/react-design-system/form"),require("@lifesg/react-design-system/toggle"),require("@lifesg/react-design-system/checkbox"),require("@lifesg/react-design-system/input-textarea"),require("@lifesg/react-design-system/file-upload"),require("@lifesg/react-icons/cross"),require("@lifesg/react-design-system/icon-button"),require("@lifesg/react-icons/pin-fill"),require("@lifesg/react-design-system"),require("@lifesg/react-design-system/image-button"),require("@lifesg/react-design-system/radio-button");exports.default=s=>{const{accepts:a,compress:r,dimensions:i,editImage:u,id:n,maxSizeInKb:l,outputType:o,upload:c,value:g}=s,{images:m,setImages:d,setErrorCount:E,setCurrentFileIds:f}=e.useContext(t.ImageContext),p=t.usePrevious(m),R=t.usePrevious(g),{setValue:I}=t.useFormContext(),S=e.useRef(),y=e.useRef(0),{dispatchFieldEvent:h,addFieldEventListener:D,removeFieldEventListener:q}=t.useFieldEvent();e.useEffect((()=>{const e=e=>{d((t=>{const s=t.findIndex((t=>t.id===e.detail.id)),a={...t[s]};a.status=e.detail.updatedStatus,a.customErrorMessage=e.detail.errorMessage;const r=[...t];return r.splice(s,1,a),r}))};return D("update-image-status",n,e),()=>q("update-image-status",n,e)}),[D,n,q,d]),e.useEffect((()=>{S.current=t.generateRandomId()}),[]),e.useEffect((()=>{m.forEach(((e,s)=>{const i=p?.[s];if(e.status!==i?.status||e.dataURL!==i.dataURL)switch(e.status){case t.EImageStatus.INJECTED:t.FileHelper.dataUrlToBlob(e.dataURL).then((a=>{d((r=>{const i=[...r];return i[s]={...e,file:new File([a],e.name),status:t.EImageStatus.NONE},i}))})).catch((()=>{d((e=>e.filter(((e,t)=>t!==s))))}));break;case t.EImageStatus.NONE:t.FileHelper.getType(e.file).then((i=>{const u=i.mime;u&&a.map(t.FileHelper.fileExtensionToMimeType).includes(u)?(d((a=>{const r=[...a];return r[s]={...e,name:t.FileHelper.deduplicateFileName(m.map((({name:e})=>e)),s,e.name),type:u,status:"schema"!==e.addedFrom?e.status:t.EImageStatus.UPLOADED},r})),"schema"!==e.addedFrom&&(r?T(s,e):U(s,e))):d((a=>{const r=[...a];return r[s]={...e,status:t.EImageStatus.ERROR_FORMAT},r}))}));break;case t.EImageStatus.TO_RECOMPRESS:L(s,e);break;case t.EImageStatus.COMPRESSED:case t.EImageStatus.CONVERTED:case t.EImageStatus.RECOMPRESSED:if(!u){const a=!h("upload-ready",n,{imageData:e});d((e=>{const r=[...e];return r[s]={...r[s],status:a?t.EImageStatus.PENDING:t.EImageStatus.UPLOAD_READY},r}))}break;case t.EImageStatus.UPLOAD_READY:w(s,e);break;case t.EImageStatus.TO_DELETE:d((e=>e.filter((({status:e})=>e!==t.EImageStatus.TO_DELETE))));break;case t.EImageStatus.UPLOADED:h("uploaded",n,{imageData:e})}}))}),[m.map((({status:e})=>e)).join(","),m.map((({dataURL:e})=>e)).join(",")]),e.useEffect((()=>{let e=0;m.forEach((s=>{(s.type&&!a.map(t.FileHelper.fileExtensionToMimeType).includes(s.type)||[t.EImageStatus.ERROR_GENERIC,t.EImageStatus.ERROR_SIZE].includes(s.status))&&e++})),E((t=>Math.max(0,t+e-y.current))),y.current=e;const s=m.filter((({status:e})=>e===t.EImageStatus.UPLOADED||e===t.EImageStatus.ERROR_CUSTOM_MUTED)),r=s.filter((({addedFrom:e})=>"schema"!==e)),i=m.filter((({status:e})=>e===t.EImageStatus.TO_DELETE)).length>0,u=r.length>0,l=u||i;f(s.map((({id:e})=>e))),I(n,s.map((({id:e,dataURL:t,drawingDataURL:s,name:a,uploadResponse:r})=>({fileId:e,fileName:a,dataURL:s||t,uploadResponse:r}))),{shouldDirty:l,shouldTouch:u})}),[a,n,m,E,I]),e.useEffect((()=>{void 0!==R&&void 0===g&&m.length&&d([])}),[void 0===R,void 0===g,m.length]);const O=(e,t)=>{let s=i.width/e;return t*s>i.height&&(s=i.height/t),s},U=async(e,s)=>{try{const a=await t.ImageHelper.convertBlob(s.file,t.FileHelper.fileExtensionToMimeType(o)),r=t.FileHelper.getFilesizeFromBase64(a);d(l&&r>1024*l?s=>{const a=[...s];return a[e]={...s[e],status:t.EImageStatus.ERROR_SIZE},a}:s=>{const r=[...s];return r[e]={...s[e],dataURL:a,status:t.EImageStatus.CONVERTED},r})}catch(s){d((s=>{const a=[...s];return a[e]={...s[e],status:t.EImageStatus.ERROR_GENERIC},a}))}},T=async(e,s)=>{try{const a=await t.ImageHelper.convertBlob(s.file,t.FileHelper.fileExtensionToMimeType(o)),r=await t.ImageHelper.dataUrlToImage(a),i={w:r.naturalWidth,h:r.naturalHeight},u=O(i.w,i.h);let n=await t.ImageHelper.resampleImage(r,{scale:u});if(l&&(n=await t.ImageHelper.compressImage(n,{fileSize:l})),l&&n.size>1024*l)d((s=>{const a=[...s];return a[e]={...s[e],status:t.EImageStatus.ERROR_SIZE},a}));else{const s=await t.FileHelper.fileToDataUrl(n);d((a=>{const r=[...a];return r[e]={...a[e],dataURL:s,status:t.EImageStatus.COMPRESSED},r}))}}catch(s){d((s=>{const a=[...s];return a[e]={...s[e],status:t.EImageStatus.ERROR_GENERIC},a}))}},L=async(e,s)=>{if(s.drawingDataURL)try{const a=await t.ImageHelper.dataUrlToImage(s.drawingDataURL),r={w:a.naturalWidth,h:a.naturalHeight},i=O(r.w,r.h);let u=await t.ImageHelper.resampleImage(a,{scale:i});if(u=await t.ImageHelper.compressImage(u,{fileSize:l}),u.size>1024*l){const s=[...m];s[e]={...m[e],status:t.EImageStatus.ERROR_SIZE},d(s)}else{const s=await t.FileHelper.fileToDataUrl(u),a=[...m];a[e]={...m[e],drawingDataURL:s,status:t.EImageStatus.RECOMPRESSED},d(a)}}catch(s){d((s=>{const a=[...s];return a[e]={...s[e],status:t.EImageStatus.ERROR_GENERIC},a}))}},w=async(e,s)=>{try{let a;if(d((s=>{const a=[...s];return a[e]={...s[e],status:t.EImageStatus.UPLOADING},a})),c?.method&&c?.url){const r=new FormData;r.append("dataURL",s.drawingDataURL||s.dataURL||""),r.append("sessionId",S.current||""),r.append("slot",`${s.slot}`),a=await new t.AxiosApiClient("",void 0,void 0,!0)[c.method](c.url,r,{onUploadProgress:t=>{const{loaded:s,total:a}=t,r=Math.floor(100*s/a);d((t=>{const s=[...t];return s[e]={...t[e],uploadProgress:r},s}))}})}d((s=>{const r=[...s];return r[e]={...s[e],uploadResponse:a,status:t.EImageStatus.UPLOADED},r}))}catch(s){d((s=>{const a=[...s];return a[e]={...s[e],status:t.EImageStatus.ERROR_GENERIC},a}))}};return null};
//# sourceMappingURL=index.a9da48de.js.map
