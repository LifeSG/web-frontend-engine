import{useContext as e,useRef as t,useEffect as s}from"react";import{e as a,u as i,a as r,b as o,g as n,f as c,d as l,I as m,A as d}from"./index.2eea32e5.js";import"react/jsx-runtime";import"@lifesg/react-design-system/media";import"@lifesg/react-design-system/text";import"@lifesg/react-design-system/color";import"styled-components";import"@lifesg/react-design-system/button";import"@lifesg/react-design-system/modal";import"@lifesg/react-design-system/markup";import"react-dom/server";import"@lifesg/react-design-system/alert";import"@lifesg/react-design-system/layout";import"@lifesg/react-design-system/box-container";import"@lifesg/react-design-system/divider";import"@lifesg/react-design-system/text-list";import"@lifesg/react-design-system/popover-v2";import"@lifesg/react-icons";import"@lifesg/react-design-system/tab";import"@lifesg/react-icons/plus-circle-fill";import"@lifesg/react-design-system/button-with-icon";import"@lifesg/react-design-system/error-display";import"@lifesg/react-design-system/filter";import"@lifesg/react-design-system/uneditable-section";import"@lifesg/react-design-system/timeline";import"@lifesg/react-design-system/form";import"@lifesg/react-design-system/toggle";import"@lifesg/react-design-system/checkbox";import"@lifesg/react-design-system/file-upload";import"@lifesg/react-icons/cross";import"@lifesg/react-design-system/icon-button";import"@lifesg/react-icons/bin";import"@lifesg/react-icons/eraser";import"@lifesg/react-icons/pencil";import"@lifesg/react-icons/pencil-stroke";import"@lifesg/react-design-system";import"@lifesg/react-icons/plus";import"@lifesg/react-icons/exclamation-triangle";import"@lifesg/react-icons/pin-fill";import"@lifesg/react-design-system/design-token";import"@lifesg/react-design-system/image-button";import"@lifesg/react-design-system/radio-button";const g=g=>{const{accepts:p,compress:u,crop:f,dimensions:E,editImage:R,id:h,maxSizeInKb:y,outputType:D,upload:w,value:O}=g,{images:U,setImages:I,setErrorCount:T,setCurrentFileIds:L}=e(a),b=i(U),S=i(O),{setValue:M}=r(),N=t(),_=t(0),{dispatchFieldEvent:v,addFieldEventListener:C,removeFieldEventListener:x}=o();s((()=>{const e=e=>{I((t=>{const s=t.findIndex((t=>t.id===e.detail.id)),a={...t[s]};a.status=e.detail.updatedStatus,a.customErrorMessage=e.detail.errorMessage;const i=[...t];return i.splice(s,1,a),i}))};return C("update-image-status",h,e),()=>x("update-image-status",h,e)}),[C,h,x,I]),s((()=>{N.current=n()}),[]),s((()=>{U.forEach(((e,t)=>{const s=b?.[t];if(e.status!==s?.status||e.dataURL!==s.dataURL)switch(e.status){case c.INJECTED:l.dataUrlToBlob(e.dataURL).then((s=>{I((a=>{const i=[...a];return i[t]={...e,file:new File([s],e.name),status:c.NONE},i}))})).catch((()=>{I((e=>e.filter(((e,s)=>s!==t))))}));break;case c.NONE:l.getType(e.file).then((s=>{const a=s.mime;a&&p.map(l.fileExtensionToMimeType).includes(a)?(I((s=>{const i=[...s];return i[t]={...e,name:l.deduplicateFileName(U.map((({name:e})=>e)),t,l.sanitizeFileName(e.name)),type:a,status:"schema"!==e.addedFrom?e.status:c.UPLOADED},i})),"schema"!==e.addedFrom&&(u?A(t,e):F(t,e))):I((s=>{const a=[...s];return a[t]={...e,status:c.ERROR_FORMAT},a}))}));break;case c.TO_RECOMPRESS:k(t,e);break;case c.COMPRESSED:case c.CONVERTED:case c.RECOMPRESSED:if(!R){const s=!v("upload-ready",h,{imageData:e});I((e=>{const a=[...e];return a[t]={...a[t],status:s?c.PENDING:c.UPLOAD_READY},a}))}break;case c.UPLOAD_READY:z(t,e);break;case c.TO_DELETE:I((e=>e.filter((({status:e})=>e!==c.TO_DELETE))));break;case c.UPLOADED:v("uploaded",h,{imageData:e})}}))}),[U.map((({status:e})=>e)).join(","),U.map((({dataURL:e})=>e)).join(",")]),s((()=>{let e=0;U.forEach((t=>{(t.type&&!p.map(l.fileExtensionToMimeType).includes(t.type)||[c.ERROR_GENERIC,c.ERROR_SIZE].includes(t.status))&&e++})),T((t=>Math.max(0,t+e-_.current))),_.current=e;const t=U.filter((({status:e})=>e===c.UPLOADED||e===c.ERROR_CUSTOM_MUTED)),s=t.filter((({addedFrom:e})=>"schema"!==e)),a=U.filter((({status:e})=>e===c.TO_DELETE)).length>0,i=s.length>0,r=i||a;L(t.map((({id:e})=>e))),M(h,t.map((({id:e,dataURL:t,drawingDataURL:s,name:a,metadata:i,uploadResponse:r})=>({fileId:e,fileName:a,dataURL:s||t,metadata:i,uploadResponse:r}))),{shouldDirty:r,shouldTouch:i})}),[p,h,U,T,M]),s((()=>{void 0!==S&&void 0===O&&U.length&&I([])}),[void 0===S,void 0===O,U.length]);const P=(e,t)=>{let s=E.width/e;return t*s>E.height&&(s=E.height/t),s},F=async(e,t)=>{try{const s=await m.convertBlob(t.file,l.fileExtensionToMimeType(D)),a=l.getFilesizeFromBase64(s);if(y&&a>1024*y)I((t=>{const s=[...t];return s[e]={...t[e],status:c.ERROR_SIZE},s}));else{const a=await m.getMetadata(t.file);I((t=>{const i=[...t];return i[e]={...t[e],dataURL:s,metadata:a,status:c.CONVERTED},i}))}}catch(t){I((t=>{const s=[...t];return s[e]={...t[e],status:c.ERROR_GENERIC},s}))}},A=async(e,t)=>{try{const s=await m.convertBlob(t.file,l.fileExtensionToMimeType(D)),a=await m.dataUrlToImage(s),i={w:a.naturalWidth,h:a.naturalHeight};let r;if(f)r=await m.resampleImage(a,{width:E.width,height:E.height,crop:!0});else{const e=P(i.w,i.h);r=await m.resampleImage(a,{scale:e})}if(y&&(r=await m.compressImage(r,{fileSize:y})),y&&r.size>1024*y)I((t=>{const s=[...t];return s[e]={...t[e],status:c.ERROR_SIZE},s}));else{const s=await m.getMetadata(t.file),a=await l.fileToDataUrl(r);I((t=>{const i=[...t];return i[e]={...t[e],dataURL:a,metadata:s,status:c.COMPRESSED},i}))}}catch(t){I((t=>{const s=[...t];return s[e]={...t[e],status:c.ERROR_GENERIC},s}))}},k=async(e,t)=>{if(t.drawingDataURL)try{const s=await m.dataUrlToImage(t.drawingDataURL),a={w:s.naturalWidth,h:s.naturalHeight};let i;if(f)i=await m.resampleImage(s,{width:E.width,height:E.height,crop:!0});else{const e=P(a.w,a.h);i=await m.resampleImage(s,{scale:e})}if(i=await m.compressImage(i,{fileSize:y}),i.size>1024*y){const t=[...U];t[e]={...U[e],status:c.ERROR_SIZE},I(t)}else{const t=await l.fileToDataUrl(i),s=[...U];s[e]={...U[e],drawingDataURL:t,status:c.RECOMPRESSED},I(s)}}catch(t){I((t=>{const s=[...t];return s[e]={...t[e],status:c.ERROR_GENERIC},s}))}},z=async(e,t)=>{try{let s;if(I((t=>{const s=[...t];return s[e]={...t[e],status:c.UPLOADING},s})),w?.method&&w?.url){const a=new FormData;a.append("dataURL",t.drawingDataURL||t.dataURL||""),a.append("sessionId",w?.sessionId||N.current||""),a.append("slot",`${t.slot}`),s=await new d("",void 0,void 0,!0)[w.method](w.url,a,{onUploadProgress:t=>{const{loaded:s,total:a}=t,i=Math.floor(100*s/a);I((t=>{const s=[...t];return s[e]={...t[e],uploadProgress:i},s}))}})}I((t=>{const a=[...t];return a[e]={...t[e],uploadResponse:s,status:c.UPLOADED},a}))}catch(t){I((t=>{const s=[...t];return s[e]={...t[e],status:c.ERROR_GENERIC},s}))}};return null};export{g as default};
//# sourceMappingURL=index.35f47b02.js.map
